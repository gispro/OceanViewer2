<% extends ./base.html %>
<% subskin extrahead %>
    <!-- OpenLayers resources -->
    <link rel="stylesheet" type="text/css" href="externals/openlayers/theme/default/style.css">
    <script type="text/javascript" src="script/OpenLayers.js"></script>

    <!-- GeoExt resources -->
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/popup.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/layerlegend.css">
    <link rel="stylesheet" type="text/css" href="externals/GeoExt/resources/css/gxtheme-gray.css">
    <script type="text/javascript" src="script/GeoExt.js"></script> 

    <!-- gxp resources -->
    <link rel="stylesheet" type="text/css" href="externals/gxp/src/theme/all.css">
    <script type="text/javascript" src="script/gxp.js"></script> 

    <!-- gispro resources -->
    <script type="text/javascript" src="externals/gispro/utils/public/javascripts/utils.js"></script>
    <script type="text/javascript" src="externals/gispro/pricker/javascripts/PrickerParser.js"></script>
    <script type="text/javascript" src="externals/gispro/pricker/javascripts/PrickerWindow.js"></script>
    <script type="text/javascript" src="externals/gispro/pricker/javascripts/Pricker.js"></script>
    <script type="text/javascript" src="externals/gispro/pricker/javascripts/PrickerTool.js"></script>
    <script type="text/javascript" src="externals/gispro/pricker/javascripts/locale/ru.js"></script>
    <link rel="stylesheet" type="text/css" href="externals/gispro/pricker/stylesheets/pricker.css">
    <script type="text/javascript" src="externals/gispro/editor/javascripts/feature_editor_panel.js"></script>
    <script type="text/javascript" src="externals/gispro/editor/javascripts/feature_editor_simple_messagebox.js"></script>
    <link rel="stylesheet" type="text/css" href="externals/gispro/editor/stylesheets/editor.css">
    <script type="text/javascript" src="externals/gispro/view_manager/public/javascripts/view_menu.js"></script>
    <script type="text/javascript" src="externals/gispro/view_manager/public/javascripts/locale/ru.js"></script>
    <script type="text/javascript" src="externals/gispro/overview_map/overview_map.js"></script>
    <script type="text/javascript" src="externals/gispro/grid_wms_get_feature_info/grid_wms_get_feature_info.js"></script>

    <!-- gispro overrides -->
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/widgets/WMSLayerPanel.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/widgets/grid/FeatureGrid.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/plugins/WMSSource.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/plugins/WMSCSource.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/plugins/FeatureManager.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/gxp/src/script/plugins/LayerProperties.js"></script>
    <script type="text/javascript" src="externals/gispro/overrides/GeoExt/lib/GeoExt/widgets/MapPanel.js"></script>

    <!-- proj4js resources -->
    <script type="text/javascript" src="externals/proj4js/lib/proj4js-compressed.js"></script>

    <script type="text/javascript">
      Proj4js.defs["EPSG:102012"] = "+proj=lcc +lat_1=30 +lat_2=62 +lat_0=0 +lon_0=105 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
      Proj4js.defs["EPSG:3576"] = "+proj=laea +lat_0=90 +lon_0=90 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
      Proj4js.defs["EPSG:4326"] = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
      Proj4js.defs["EPSG:91101"] = "+title=long/lat:WGS84 +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"
      Proj4js.defs["EPSG:3413"] = "+proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
      Proj4js.defs["EPSG:3995"] = "+proj=stere +lat_0=90 +lat_ts=71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";            
      Proj4js.defs["EPSG:3976"] = "+proj=stere +lat_0=-90 +lat_ts=-70 +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";            
    </script>

    <!-- GeoExplorer resources -->
    <link rel="stylesheet" type="text/css" href="theme/app/geoexplorer.css" />
    <!--[if IE]><link rel="stylesheet" type="text/css" href="theme/app/ie.css"/><![endif]-->        
    <link rel="stylesheet" type="text/css" href="theme/ux/colorpicker/color-picker.ux.css" />
    <script type="text/javascript" src="script/GeoExplorer.js"></script>
    <script type="text/javascript" src="script/ux.js"></script>

    <!-- PrintPreview resources -->
    <link rel="stylesheet" type="text/css" href="externals/PrintPreview/resources/css/printpreview.css">
    <script type="text/javascript" src="script/PrintPreview.js"></script>

    <!--<script type="text/javascript" src="script/app/graticuleGxpTool.js"></script>-->
    <script type="text/javascript" src="script/choosers.js"></script>
    <!--<script type="text/javascript" src="script/app/ServicesSetting.js"></script>-->

    <script>

        Ext.BLANK_IMAGE_URL = "theme/app/img/blank.gif";
        OpenLayers.ImgPath = "externals/openlayers/img/";

        // optionally set locale based on query string parameter
        if (GeoExt.Lang) {
            //GeoExt.Lang.set(OpenLayers.Util.getParameters()["locale"] || GeoExt.Lang.locale);
            GeoExt.Lang.set("ru");
        }
        
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		Ext.override(OpenLayers.Layer.GeoRSS, {
			parseData: RssPopupParseData
		});

		Ext.override(OpenLayers.Control.WMSGetFeatureInfo, {
			getInfoForClick: RssPopupGetInfoForClick
		});

		Ext.override(GeoExt.tree.LayerNode, {
			render: RssPopupLayerNodeRender
		});

		Ext.override(gxp.Viewer, {
			getState: RssPopupGetState
		});

		Ext.override(GeoExt.tree.LayerLoader, {
			addLayerNode: RsspopupAddLayerNode
		});
		
		Ext.override(gxp.plugins.RemoveLayer, {
			addActions: RssPopupAddActions
		});

		//Ext.override(gxp.WMSLayerPanel, {
		//	createDisplayPanel: RssSourceCreateDisplayPanel
		//});
		
		Ext.override(GeoExt.LegendPanel, {
			addLegend : animationAddLegend
		});
                
		Ext.override(GeoExt.tree.LayerNode, {
			render : animationRender
		});

		Ext.override(GeoExt.LegendPanel, {
			recordIndexToPanelIndex : animationRecordIndexToPanelIndex
		});
		
		Ext.override(GeoExt.data.LayerStore, {
			onAdd : animationOnAdd
		});

		Ext.override(GeoExt.tree.LayerNode, {
			onStoreAdd : animationOnStoreAdd
		});
		
		Ext.override(GeoExt.tree.LayerLoader, {
			onStoreAdd : animationLayerLoaderOnStoreAdd
		});
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        var app = new GeoExplorer.Composer({
            //username: 'admin',
            //password: 'geoserver',
            //username: 'edit',
            //password: 'pedit',
            authWay: false, //josso,ov
            proxy: "/proxy/?url=",
            authUrl: "http://oceanviewer.ru/josso/signon/",
            printService: "http://oceanviewer.ru/print/pdf/",
            jossoLoginLocation: ' http://oceanviewer.ru/josso/signon/usernamePasswordLogin.do',
            about: {
                title: "Карта OceanViewer",
                "abstract": "Сохраненная карта OceanViewer",
                contact: "Разработчик приложения <a href='http://www.gispro.ru'>ЗАО 'ГИСпроект'</a>"
            },
            defaultSourceType: "gxp_wmscsource",
            sources: {
                arcgis93: { ptype: "gxp_arcgis93source" },
                rss: { ptype: "gxp_rsssource" },
                google: { ptype: "gxp_googlesource" },
                osm: { ptype: "gxp_osmsource" },
                baselayer: { ptype: "gxp_olsource", },
                animation: { ptype: "gxp_animationsource" }
                ,editable: {
                    //url: "http://192.168.0.171:8080/geoserver/wms",
                    url: "http://oceanviewer.ru/user/ru_hydrometcentre_61/wms",
                    restUrl: "http://oceanviewer.ru/user/rest",
                    title: "Редактируемые"
                }
                ,gispro: {
                    //url: "/cache/service/wms",
                    url: "http://oceanviewer.ru/cache/service/wms",
                    title: "Слои картоосновы"
                }
            },

            map: {
                projection: "EPSG:900913",
                layers: [
                  {
                     source: "baselayer",
                     group: "background",
                     fixed: true,
                     type: "OpenLayers.Layer",
                     args: [
                         "Без картоосновы", {visibility: false}
                     ]
                  }
                  ,{
                     source: "google",
                     title: "Google Карта",
                     name: "ROADMAP",
                     group: "background"
                  }
                  ,{
                     source: "google",
                     title: "Google Рельеф",
                     name: "TERRAIN",
                     group: "background"
                  }
                  ,{
                     source: "google",
                     title: "Google Спутник",
                     name: "SATELLITE",
                     group: "background"
                  }
                  ,{
                     source: "google",
                     title: "Google Гибрид",
                     name: "HYBRID",
                     group: "background"
                  }
                  ,{
                     source: "osm",
                     name: "mapnik",
                     group: "background"
                  }
                  ,{
                     source: "gispro",
                     title: "ЭКО 3.1 бланк",
                     name: "eko_blank",
                     group: "background",
                     args: [null, {alwaysInRange: true}],
                     queryable: false
                  }
                  ,{
                     source: "gispro",
                     title: "ЭКО 3.1",
                     name: "eko_merge",
                     group: "background",
                     args: [null, {alwaysInRange: true}],
                     queryable: false
                  }
                  ,{
                    //name:"userlayers:pointlayer",
                    name:"ru_hydrometcentre_61:pointlayer",
                    source:"editable",
                    group:'editable',
                    cached: false,
                    visibility: false
                  }
                  ,{
                    //name:"userlayers:linelayer",
                    name:"ru_hydrometcentre_61:linelayer",
                    source:"editable",
                    group:'editable',
                    cached: false,
                    visibility: false
                  }
                  ,{
                    //name:"userlayers:polylayer",
                    name:"ru_hydrometcentre_61:polylayer",
                    source:"editable",
                    group:'editable',
                    cached: false,
                    visibility: false
                  }
                ],
                center: [0, 0],
                zoom: 2
            }
        })


        downloadArcgis()
        downloadRSS()
        wmsStore.load()


        //app.on('portalready', function(){
        //  var im = new Image()
        //  im.src = 'http://oceanviewer.ru:80/resources/ru_hydrometcentre_42/wms?SERVICE=WMS&STYLES=&FORMAT=image%2Fpng&TRANSPARENT=TRUE&LAYERS=ru_hydrometcentre_42%3Aru_hydrometcentre_42_10_p0001_00_ln&VERSION=1.1.1&REQUEST=GetMap&TILED=true&SRS=EPSG%3A900913&BBOX=-20037508.34,-20037508.34,20037508.34,20037508.34&WIDTH=256&HEIGHT=256'
        //  //setTimeout(function(){
        //  //  var t = document.cookie.match(/ JOSSO_SESSIONID_josso/)
        //  //  if(!t){
        //  //    document.location=app.jossoLoginLocation + '?josso_back_to=' + document.location.href
        //  //  }
        //  //}, 10000)
        //  //im.onload = function(){
        //  //  document.body.appendChild(im)
        //  //  setTimeout(function(){
        //  //    document.body.removeChild(im)
        //  //  }, 2000)
        //  //}
        //  //im.onabort = function(){
        //  //    document.location=app.jossoLoginLocation + '?josso_back_to=' + document.location.href
        //  //}
        //  //im.onerror = function(){
        //  //    document.location=app.jossoLoginLocation + '?josso_back_to=' + document.location.href
        //  //}
        //})

        app.on("ready", function()
          {
            Ext.QuickTips.getQuickTip().maxWidth = 800
            animationStore.load()
            aquaStore.load()

            this.mapPanel.on('beforeprojectionchanged', function(projection){
              if(projection == 'EPSG:900913' || projection == 'EPSG:4326'){
                //this - mapPanel
                this.layers.each(function(rec){
                  if(rec.getLayer().params && rec.getLayer().params.LAYERS == 'eko_merge_v'){
                    rec.getLayer().params.LAYERS = 'eko_merge'
                  }})
              } else if (projection == 'EPSG:102012' || projection == 'EPSG:3576' || projection == 'EPSG:3976') {
                //this - mapPanel
                this.layers.each(function(rec){
                  if(rec.getLayer().params && rec.getLayer().params.LAYERS == 'eko_merge'){
                    rec.getLayer().params.LAYERS = 'eko_merge_v'
                  }})
              }
            })

            //background
            //this.mapPanel.map.div.style.background = '#bdf'

            //google hybrid after resize bug fix
            //TODO move to source
            var gobj
            for(var i=0, len=app.mapPanel.map.layers.length; i<len; i++){
              if( app.mapPanel.map.layers[i].type == 'hybrid'){
                gobj=app.mapPanel.map.layers[i].mapObject
              }
            }
            app.mapPanel.on( 'afterlayout', function(){
              google.maps.event.trigger(gobj, 'resize')
            } )


           //dinamic layers adding
           //app.mapPanel.layers.add([ app.layerSources['editable'].createLayerRecord({ name:"userlayers:pointlayer", source:"editable", group:'editable', cached: false, visibility: false}) ])

          })



    </script>
